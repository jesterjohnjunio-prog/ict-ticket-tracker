<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICT Concerns - New Tickets Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: #f5f7fa; color: #333; padding: 20px; }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(to right, #4a6fa5, #2c5282);
            color: white;
            padding: 25px 30px;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            min-width: 150px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .controls {
            padding: 20px 30px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        #searchInput {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .refresh-btn {
            background: #4a6fa5;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .table-container {
            padding: 20px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        th {
            background: #f1f5f9;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #475569;
            border-bottom: 2px solid #e2e8f0;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: top;
        }
        
        tr:hover {
            background: #f8fafc;
        }
        
        .ticket-id {
            background: #f7fafc;
            padding: 5px 10px;
            border-radius: 5px;
            font-family: monospace;
            font-weight: bold;
        }
        
        .problem-tag {
            background: #e2e8f0;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 5px;
        }
        
        .description {
            color: #64748b;
            font-size: 0.9rem;
            line-height: 1.4;
            max-width: 300px;
        }
        
        .mis-personnel {
            background: #ebf8ff;
            color: #2c6bc7;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }
        
        .error {
            text-align: center;
            padding: 60px 20px;
            color: #e53e3e;
        }
        
        .error button {
            margin-top: 20px;
            background: #4a6fa5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-ticket-alt"></i> ICT Concerns - New Tickets Tracker</h1>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalTickets">0</div>
                    <div>New Tickets</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="todayTickets">0</div>
                    <div>Today's Tickets</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="uniquePersonnel">0</div>
                    <div>MIS Personnel</div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <input type="text" id="searchInput" placeholder="Search new tickets...">
            <button id="refreshBtn" class="refresh-btn">
                <i class="fas fa-redo-alt"></i> Refresh
            </button>
        </div>
        
        <div class="table-container">
            <div id="loading" class="loading">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p>Loading new tickets...</p>
            </div>
            
            <div id="error" class="error" style="display: none;">
                <i class="fas fa-exclamation-triangle fa-2x"></i>
                <h3>Unable to load tickets</h3>
                <p id="errorMessage">Please check your connection and try again.</p>
                <button onclick="loadTickets()">Try Again</button>
            </div>
            
            <table id="ticketsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Ticket ID</th>
                        <th>Date</th>
                        <th>Talent Name</th>
                        <th>Problem Encountered</th>
                        <th>Description</th>
                        <th>Preferred MIS Personnel</th>
                    </tr>
                </thead>
                <tbody id="ticketsBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        async function loadTickets() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const table = document.getElementById('ticketsTable');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            table.style.display = 'none';
            
            try {
                // Use CSV export from the Active Tickets sheet (gid=1959752412)
                const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSlQLcK_Ktw2zemNHDZ_70giWPqT54Mvoci_dJxQz1RWYhe94UaDQLPQU89DUYLTY-ow7s2sWa-PB0h/pub?gid=1959752412&single=true&output=csv';
                
                console.log('Loading from Active Tickets sheet:', csvUrl);
                
                const response = await fetch(csvUrl);
                const csvText = await response.text();
                
                // Parse CSV
                const rows = csvText.split('\n');
                const tickets = [];
                
                // Filter for "New" tickets - adjust this logic based on your sheet structure
                // If you have a status column, you can add filtering here
                for (let i = 1; i < rows.length; i++) {
                    if (rows[i].trim() === '') continue;
                    
                    // Parse CSV row
                    const cols = parseCSVRow(rows[i]);
                    
                    // Only use columns A-F (0-5)
                    if (cols.length >= 6) {
                        const ticket = {
                            'Ticket ID': cols[0] || '',
                            'Date': cols[1] || '',
                            'Talent Name': cols[2] || '',
                            'Problem Encountered': cols[3] || '',
                            'Description': cols[4] || '',
                            'Preferred MIS Personnel': cols[5] || '' // Column F
                        };
                        
                        // Add filtering logic here for "New" tickets
                        // Example: if (ticket.Status === 'New') tickets.push(ticket);
                        // For now, pushing all tickets from Active Tickets sheet
                        tickets.push(ticket);
                    }
                }
                
                console.log('Loaded', tickets.length, 'new tickets from Active Tickets sheet');
                
                if (tickets.length > 0) {
                    displayTickets(tickets);
                    updateStats(tickets);
                } else {
                    throw new Error('No tickets found in Active Tickets sheet');
                }
                
            } catch (err) {
                console.error('Error:', err);
                document.getElementById('errorMessage').textContent = err.message;
                error.style.display = 'block';
                loading.style.display = 'none';
            }
        }
        
        function parseCSVRow(row) {
            const cols = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    cols.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            cols.push(current.trim());
            return cols;
        }
        
        function displayTickets(tickets) {
            const tbody = document.getElementById('ticketsBody');
            const loading = document.getElementById('loading');
            const table = document.getElementById('ticketsTable');
            
            tbody.innerHTML = '';
            
            tickets.forEach(ticket => {
                const row = document.createElement('tr');
                
                // Format date
                let date = ticket.Date;
                try {
                    const dateObj = new Date(ticket.Date);
                    if (!isNaN(dateObj.getTime())) {
                        date = dateObj.toLocaleDateString();
                    }
                } catch (e) {}
                
                row.innerHTML = `
                    <td><span class="ticket-id">${ticket['Ticket ID'] || 'N/A'}</span></td>
                    <td>${date}</td>
                    <td><strong>${ticket['Talent Name'] || 'N/A'}</strong></td>
                    <td>
                        <div class="problem-tag">${ticket['Problem Encountered'] || 'Not specified'}</div>
                    </td>
                    <td><div class="description">${ticket['Description'] || 'No description'}</div></td>
                    <td>
                        <span class="mis-personnel">
                            <i class="fas fa-user"></i>
                            ${ticket['Preferred MIS Personnel'] || 'Unassigned'}
                        </span>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            loading.style.display = 'none';
            table.style.display = 'table';
        }
        
        function updateStats(tickets) {
            document.getElementById('totalTickets').textContent = tickets.length;
            
            const today = new Date().toISOString().split('T')[0];
            const todayTickets = tickets.filter(t => {
                try {
                    const ticketDate = new Date(t.Date).toISOString().split('T')[0];
                    return ticketDate === today;
                } catch (e) {
                    return false;
                }
            }).length;
            document.getElementById('todayTickets').textContent = todayTickets;
            
            const personnel = [...new Set(tickets.map(t => t['Preferred MIS Personnel']).filter(Boolean))];
            document.getElementById('uniquePersonnel').textContent = personnel.length;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('refreshBtn').addEventListener('click', loadTickets);
            
            // Setup search
            document.getElementById('searchInput').addEventListener('input', function(e) {
                const search = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#ticketsBody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(search) ? '' : 'none';
                });
            });
            
            // Load tickets
            loadTickets();
            
            // Auto-refresh every 5 minutes
            setInterval(loadTickets, 5 * 60 * 1000);
        });
    </script>
</body>
</html>
